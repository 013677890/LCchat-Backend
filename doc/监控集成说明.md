# Gateway ç›‘æ§é›†æˆè¯´æ˜

## ğŸ“Š ç›‘æ§æ¶æ„

é‡‡ç”¨ä¸šç•Œæ ‡å‡†çš„ **Prometheus + Grafana** ç›‘æ§æ–¹æ¡ˆï¼š

- **Prometheus**ï¼šè´Ÿè´£æ”¶é›†å’Œå­˜å‚¨ç›‘æ§æ•°æ®ï¼ˆæ¯ 15 ç§’æ‹‰å–ä¸€æ¬¡ï¼‰
- **Grafana**ï¼šè´Ÿè´£æ•°æ®å¯è§†åŒ–å±•ç¤º

## ğŸš€ å·²å®ç°çš„ç›‘æ§æŒ‡æ ‡

### HTTP ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| `gateway_http_requests_total` | Counter | HTTP è¯·æ±‚æ€»æ•° | method, path, status |
| `gateway_http_request_duration_seconds` | Histogram | HTTP è¯·æ±‚è€—æ—¶åˆ†å¸ƒ | method, path |
| `gateway_http_request_size_bytes` | Histogram | HTTP è¯·æ±‚ä½“å¤§å°åˆ†å¸ƒ | method, path |
| `gateway_http_response_size_bytes` | Histogram | HTTP å“åº”ä½“å¤§å°åˆ†å¸ƒ | method, path |
| `gateway_http_requests_in_progress` | Gauge | å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•° | method |

### gRPC ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡åç§° | ç±»å‹ | è¯´æ˜ | æ ‡ç­¾ |
|---------|------|------|------|
| `gateway_grpc_requests_total` | Counter | gRPC è¯·æ±‚æ€»æ•° | service, method, status |
| `gateway_grpc_request_duration_seconds` | Histogram | gRPC è¯·æ±‚è€—æ—¶åˆ†å¸ƒ | service, method |

## ğŸ“¡ å¦‚ä½•è®¿é—®ç›‘æ§æ•°æ®

### 1. å¯åŠ¨ Gateway æœåŠ¡

```bash
cd apps/gateway
go run cmd/main.go
```

æœåŠ¡å¯åŠ¨åï¼Œè®¿é—® http://localhost:8080/metrics å³å¯æŸ¥çœ‹åŸå§‹ç›‘æ§æ•°æ®ã€‚

### 2. ç¤ºä¾‹ï¼š/metrics æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼

```
# HELP gateway_http_requests_total Total number of HTTP requests processed by the gateway
# TYPE gateway_http_requests_total counter
gateway_http_requests_total{method="POST",path="/api/v1/public/login",status="200"} 100
gateway_http_requests_total{method="POST",path="/api/v1/public/login",status="401"} 5

# HELP gateway_http_request_duration_seconds HTTP request latency distributions in seconds
# TYPE gateway_http_request_duration_seconds histogram
gateway_http_request_duration_seconds_bucket{method="POST",path="/api/v1/public/login",le="0.005"} 10
gateway_http_request_duration_seconds_bucket{method="POST",path="/api/v1/public/login",le="0.01"} 20
gateway_http_request_duration_seconds_bucket{method="POST",path="/api/v1/public/login",le="0.025"} 50
gateway_http_request_duration_seconds_bucket{method="POST",path="/api/v1/public/login",le="0.05"} 80
gateway_http_request_duration_seconds_bucket{method="POST",path="/api/v1/public/login",le="0.1"} 100
gateway_http_request_duration_seconds_bucket{method="POST",path="/api/v1/public/login",le="+Inf"} 100
gateway_http_request_duration_seconds_sum{method="POST",path="/api/v1/public/login",le="0.1"} 5.5
gateway_http_request_duration_seconds_count{method="POST",path="/api/v1/public/login",le="0.1"} 100

# HELP gateway_http_requests_in_progress Number of HTTP requests currently being processed
# TYPE gateway_http_requests_in_progress gauge
gateway_http_requests_in_progress{method="POST"} 3
gateway_http_requests_in_progress{method="GET"} 5
```

## ğŸ”§ Prometheus é…ç½®

### 1. å®‰è£… Prometheus

#### Linux/Mac
```bash
# ä¸‹è½½ Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xvfz prometheus-2.45.0.linux-amd64.tar.gz
cd prometheus-2.45.0.linux-amd64

# å¯åŠ¨ Prometheus
./prometheus
```

#### Docker
```bash
docker run -d \
  --name=prometheus \
  -p 9090:9090 \
  -v /path/to/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus
```

### 2. é…ç½® Prometheusï¼ˆprometheus.ymlï¼‰

```yaml
global:
  scrape_interval: 15s  # æ¯ 15 ç§’æ‹‰å–ä¸€æ¬¡æ•°æ®
  evaluation_interval: 15s

scrape_configs:
  # Gateway æœåŠ¡ç›‘æ§
  - job_name: 'chatserver-gateway'
    static_configs:
      - targets: ['localhost:8080']
        labels:
          service: 'gateway'
          environment: 'development'

  # å¦‚æœæœ‰å…¶ä»–æœåŠ¡ï¼ˆå¦‚ user-serviceï¼‰ï¼Œä¹Ÿåœ¨è¿™é‡Œé…ç½®
  - job_name: 'chatserver-user-service'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'user-service'
          environment: 'development'
```

### 3. å¯åŠ¨ Prometheus

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
./prometheus --config.file=prometheus.yml
```

è®¿é—® http://localhost:9090 å³å¯æŸ¥çœ‹ Prometheus UIã€‚

### 4. éªŒè¯æ•°æ®é‡‡é›†

åœ¨ Prometheus UI ä¸­æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢ï¼Œç¡®è®¤æ•°æ®æ­£å¸¸ï¼š

```promql
# HTTP è¯·æ±‚æ€»æ•°
rate(gateway_http_requests_total[1m])

# HTTP è¯·æ±‚ P95 è€—æ—¶
histogram_quantile(0.95, rate(gateway_http_request_duration_seconds_bucket[5m]))

# å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°
gateway_http_requests_in_progress
```

## ğŸ“ˆ Grafana å¯è§†åŒ–é…ç½®

### 1. å®‰è£… Grafana

#### Dockerï¼ˆæ¨èï¼‰
```bash
docker run -d \
  --name=grafana \
  -p 3000:3000 \
  grafana/grafana
```

è®¿é—® http://localhost:3000ï¼Œé»˜è®¤è´¦å·å¯†ç ï¼š`admin/admin`

### 2. æ·»åŠ  Prometheus æ•°æ®æº

1. ç™»å½• Grafana â†’ Configuration â†’ Data Sources â†’ Add data source
2. é€‰æ‹© "Prometheus"
3. å¡«å†™ URLï¼š`http://localhost:9090`
4. ç‚¹å‡» "Save & Test"

### 3. åˆ›å»º Dashboard

#### ç¤ºä¾‹æŸ¥è¯¢è¯­å¥

**é¢æ¿ 1ï¼šHTTP è¯·æ±‚é€Ÿç‡ï¼ˆQPSï¼‰**
```promql
sum(rate(gateway_http_requests_total[5m])) by (path)
```

**é¢æ¿ 2ï¼šHTTP è¯·æ±‚ P95 è€—æ—¶**
```promql
histogram_quantile(0.95, sum(rate(gateway_http_request_duration_seconds_bucket[5m])) by (le, path))
```

**é¢æ¿ 3ï¼šHTTP é”™è¯¯ç‡**
```promql
sum(rate(gateway_http_requests_total{status=~"5.."}[5m])) by (path)
```

**é¢æ¿ 4ï¼šHTTP è¯·æ±‚åˆ†å¸ƒ**
```promql
sum(rate(gateway_http_requests_total[5m])) by (status)
```

**é¢æ¿ 5ï¼šå½“å‰å¹¶å‘è¯·æ±‚æ•°**
```promql
sum(gateway_http_requests_in_progress) by (method)
```

**é¢æ¿ 6ï¼šgRPC è¯·æ±‚ P95 è€—æ—¶**
```promql
histogram_quantile(0.95, sum(rate(gateway_grpc_request_duration_seconds_bucket[5m])) by (le, method))
```

### 4. å¯¼å…¥é¢„ç½® Dashboard

Grafana æä¾›äº†å¾ˆå¤šç°æˆçš„æ¨¡æ¿ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥ï¼š

1. è®¿é—® https://grafana.com/grafana/dashboards/
2. æœç´¢ "Gin" æˆ– "HTTP API"
3. æ‰¾åˆ°åˆé€‚çš„ Dashboardï¼Œå¤åˆ¶ ID
4. åœ¨ Grafana ä¸­ï¼šCreate â†’ Import â†’ è¾“å…¥ ID

æ¨è Dashboardï¼š
- **ID: 11212** - Go Gin Monitoring
- **ID: 16098** - Prometheus HTTP Statistics

## ğŸ¯ ç›‘æ§æœ€ä½³å®è·µ

### 1. å…³é”®æŒ‡æ ‡å…³æ³¨ç‚¹

- **P95/P99 è€—æ—¶**ï¼šè¶…è¿‡ 500ms éœ€è¦å…³æ³¨
- **é”™è¯¯ç‡**ï¼šé”™è¯¯ç‡è¶…è¿‡ 1% éœ€è¦å‘Šè­¦
- **QPS**ï¼šå¼‚å¸¸æ³¢åŠ¨å¯èƒ½è¡¨ç¤ºæ”»å‡»æˆ–æ•…éšœ
- **å¹¶å‘æ•°**ï¼šçªç„¶é£™å‡å¯èƒ½è¡¨ç¤ºæœåŠ¡å¡é¡¿

### 2. å‘Šè­¦è§„åˆ™ç¤ºä¾‹ï¼ˆprometheus.ymlï¼‰

```yaml
groups:
  - name: chatserver_alerts
    interval: 30s
    rules:
      # HTTP P95 è€—æ—¶å‘Šè­¦
      - alert: HighHTTPLatency
        expr: histogram_quantile(0.95, sum(rate(gateway_http_request_duration_seconds_bucket[5m])) by (le, path)) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "HTTP P95 è€—æ—¶è¿‡é«˜"
          description: "æ¥å£ {{ $labels.path }} çš„ P95 è€—æ—¶è¶…è¿‡ 500ms"

      # HTTP é”™è¯¯ç‡å‘Šè­¦
      - alert: HighHTTPErrorRate
        expr: sum(rate(gateway_http_requests_total{status=~"5.."}[5m])) by (path) / sum(rate(gateway_http_requests_total[5m])) by (path) > 0.01
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "HTTP é”™è¯¯ç‡è¿‡é«˜"
          description: "æ¥å£ {{ $labels.path }} çš„é”™è¯¯ç‡è¶…è¿‡ 1%"

      # æœåŠ¡ä¸å¯ç”¨å‘Šè­¦
      - alert: ServiceDown
        expr: up{job="chatserver-gateway"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Gateway æœåŠ¡ä¸å¯ç”¨"
```

## ğŸ“ è‡ªå®šä¹‰æŒ‡æ ‡

å¦‚æœéœ€è¦æ·»åŠ æ–°çš„ç›‘æ§æŒ‡æ ‡ï¼Œå‚è€ƒä»¥ä¸‹æ­¥éª¤ï¼š

### 1. åœ¨ `metrics.go` ä¸­å®šä¹‰æŒ‡æ ‡

```go
// æ–°çš„æŒ‡æ ‡
var myCustomMetric = promauto.NewCounterVec(
    prometheus.CounterOpts{
        Name: "gateway_custom_metric",
        Help: "Description of my custom metric",
    },
    []string{"label1", "label2"},
)
```

### 2. åœ¨ä»£ç ä¸­ä½¿ç”¨

```go
// å¢åŠ è®¡æ•°
myCustomMetric.WithLabelValues("value1", "value2").Inc()

// è®¾ç½®å€¼ï¼ˆå¯¹äº Gaugeï¼‰
myCustomMetric.WithLabelValues("value1", "value2").Set(42)
```

### 3. éªŒè¯æŒ‡æ ‡

è®¿é—® `/metrics` æ¥å£ï¼Œç¡®è®¤æ–°æŒ‡æ ‡å‡ºç°ã€‚

## ğŸš¨ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼š/metrics æ¥å£æ— æ•°æ®

**å¯èƒ½åŸå› **ï¼š
- ä¸­é—´ä»¶æœªæ­£ç¡®æ³¨å†Œ
- æœåŠ¡æœªå¯åŠ¨

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥è·¯ç”±é…ç½®ï¼Œç¡®è®¤ `PrometheusMiddleware()` å·²æ·»åŠ 
- ç¡®è®¤æœåŠ¡å·²å¯åŠ¨å¹¶ç›‘å¬æ­£ç¡®ç«¯å£

### é—®é¢˜ 2ï¼šPrometheus æ— æ³•æ‹‰å–æ•°æ®

**å¯èƒ½åŸå› **ï¼š
- ç«¯å£é…ç½®é”™è¯¯
- ç½‘ç»œä¸é€š

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ `prometheus.yml` ä¸­çš„ targets é…ç½®
- ä½¿ç”¨ curl æµ‹è¯•ï¼š`curl http://localhost:8080/metrics`

### é—®é¢˜ 3ï¼šGrafana æ— æ³•æ˜¾ç¤ºæ•°æ®

**å¯èƒ½åŸå› **ï¼š
- æ•°æ®æºé…ç½®é”™è¯¯
- æŸ¥è¯¢è¯­å¥æœ‰è¯¯

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥æ•°æ®æº URL æ˜¯å¦æ­£ç¡®
- åœ¨ Prometheus UI ä¸­å…ˆéªŒè¯æŸ¥è¯¢è¯­å¥

## ğŸ“š å‚è€ƒèµ„æº

- [Prometheus å®˜æ–¹æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafana å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/)
- [Prometheus å®¢æˆ·ç«¯åº“](https://github.com/prometheus/client_golang)
- [PromQL æŸ¥è¯¢è¯­è¨€](https://prometheus.io/docs/prometheus/latest/querying/basics/)

