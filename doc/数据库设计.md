## 数据库设计汇总（当前版本）

> UUID 统一使用 `char(20)`（与现有模型一致）；如需更安全可升级为 ULID/UUID 压缩（char 26/32），需同步调整各表字段与索引。

### user_info（用户基础信息）
- id bigint PK
- uuid char(20) 唯一
- nickname varchar(20)
- telephone varchar(20) 唯一
- email varchar(100)
- avatar varchar(255)（当前 DB 默认外链，可改默认空串由应用填充）
- gender tinyint（0 男 1 女，建议预留 2 未知）
- signature varchar(100)
- password char(60)（存哈希）
- birthday char(8)（yyyyMMdd，建议改用 date）
- is_admin tinyint，status tinyint（0 正常 1 禁用）
- created_at / updated_at / deleted_at（软删）

### group_info（群基础信息）
- id bigint PK
- uuid char(20) 唯一
- name varchar(64)
- notice varchar(500)
- member_cnt int 默认 1
- owner_uuid char(20)（索引）
- add_mode tinyint（0 直接 1 审核）
- avatar varchar(255)（当前默认外链，可改为空串由应用填充）
- status tinyint（0 正常 1 禁用 2 解散）
- created_at / updated_at / deleted_at

### group_member（群成员关系）
- id bigint PK
- group_uuid char(20)
- user_uuid char(20)
- 唯一索引 (group_uuid, user_uuid)
- role tinyint（0 成员 1 管理员 2 群主）
- remark varchar(64)
- status tinyint（0 正常 1 退出 2 踢出 3 待审核）
- mute_until datetime 可空
- inviter_uuid char(20)
- joined_at / created_at / updated_at / deleted_at

### user_relation（用户单向关系）
- id bigint PK
- user_uuid char(20)
- peer_uuid char(20)
- 唯一索引 (user_uuid, peer_uuid)
- status tinyint（0 正常 1 已拉黑(原先为好友) 2 已删除 3 已拉黑(原先非好友)）
- remark varchar(64)
- source varchar(64)
- group_tag varchar(32)
- blacklisted_at datetime 可空（拉黑时间，仅 status=1/3 有效）
- created_at / updated_at / deleted_at

### apply_request（好友/加群申请）
- id bigint PK
- apply_type tinyint（0 好友 1 加群）
- applicant_uuid char(20)
- target_uuid char(20)（好友=对方用户；加群=群 UUID）
- 联合索引 (applicant_uuid, target_uuid)
- status tinyint（0 待处理 1 通过 2 拒绝 3 过期）
- is_read bool（已读标记）
- reason varchar(255)，source varchar(32)，handle_user_uuid char(20)，handle_remark varchar(255)
- expired_at datetime 可空
- created_at / updated_at / deleted_at
- 业务规则：同一申请人再次申请时，建议复用 status=0 的记录，重置 is_read=0 并更新 updated_at

### conversation（会话元数据，单聊/群聊）
- id bigint PK
- conv_id char(40)（可用 p2p-sorted(<uid_a>,<uid_b>) 或群 UUID）
- type tinyint（0 单聊 1 群聊）
- owner_uuid char(20)
- target_uuid char(20)（单聊=对端；群聊=群 UUID）
- 唯一索引 (owner_uuid, target_uuid)
- 复合索引 idx_owner_status_update (owner_uuid, status, updated_at DESC) 用于快速列表查询
- last_msg_id char(64)，last_msg_preview varchar(255)，last_msg_at datetime
- unread_count int，mute bool，pin bool，status tinyint（0 正常 1 关闭）
- created_at / updated_at / deleted_at

### message（消息表，含系统控制类消息）
- id bigint PK
- conv_id char(40) 索引 idx_conv_seq / idx_conv_time
- seq bigint 会话内序号（idx_conv_seq）
- msg_id char(64) 唯一
- client_msg_id char(64) 唯一（uidx_sender_client，客户端幂等）
- from_uuid char(20) 必填（系统/官方号用保留账号）
- msg_type smallint（0-99 普通气泡，100+ 控制类，见 const.go）
- content json（按 msg_type 解析）
- status tinyint（0 正常 1 撤回 2 删除）
- send_time datetime（idx_conv_time）
- created_at / updated_at / deleted_at

### device_session（设备/登录态）
- id bigint PK
- user_uuid char(20)
- device_id varchar(64)
- 唯一索引 (user_uuid, device_id)
- device_name varchar(64)，platform varchar(32)
- token / refresh_token varchar(2048)（可选持久化）
- app_version varchar(32)，ip varchar(64)，user_agent varchar(255)
- expire_at datetime（索引用于清理），last_seen_at datetime
- status tinyint（0 在线 1 离线 2 注销 3 被踢出）
- created_at / updated_at / deleted_at

## 索引与约束建议（补充）
- user_info：unique(uuid)、unique(telephone)、可选 unique(email)；index(status)。
- group_info：unique(uuid)、index(owner_uuid)、index(status)。
- group_member：unique(group_uuid, user_uuid)、index(role)、index(status)。
- user_relation：unique(user_uuid, peer_uuid)。
- apply_request：index(applicant_uuid, target_uuid)、index(status)。
- conversation：unique(owner_uuid, target_uuid)、idx_owner_status_update(owner_uuid,status,updated_at DESC)、index(conv_id)。
- message：unique(msg_id)、unique(client_msg_id)、index(conv_id, seq)、index(conv_id, send_time)。
- device_session：unique(user_uuid, device_id)、index(expire_at)。

## 待决策项
- UUID 长度与格式（20 → ULID/UUID）。
- avatar 默认值由应用层填充或 DB 默认空串。
- birthday 是否改用 date。
- 是否在数据库层加 FK（目前依赖应用层校验）。
- msg_type 枚举完善（const.go）并与前端/服务端协议对齐。

