# 实现行为风险记账

更新时间：2026-02-06  
范围：Gateway + User（单测阶段发现）

## 记录规范
- `风险ID`：模块前缀 + 递增编号，例如 `AUTH-001`。
- `状态`：`Open` / `Accepted` / `Fixed`。
- `处置策略`：仅记账、不改代码，或安排修复。

## 风险清单

| 风险ID | 模块 | 现实现行为 | 预期行为 | 影响 | 严重级别 | 状态 |
| --- | --- | --- | --- | --- | --- | --- |
| AUTH-001 | Gateway Auth Service | `Logout` / `ResetPassword` 成功时返回 `nil response` | 成功时返回空响应对象（非 `nil`）或统一约定 `nil` 并显式文档化 | 调用方若误判为非空对象，存在空指针/契约不一致风险 | 中 | Fixed |
| BLACKLIST-001 | Gateway Blacklist Handler | `GetBlacklistList` 先 `ShouldBindQuery` 且参数有 `min=1` 校验，`page/pageSize` 缺失时直接参数错误，默认值回填分支不可达 | 缺省分页参数时自动回填 `page=1`、`pageSize=20` | 接口行为与“默认分页”设计不一致，调用方体验不稳定 | 中 | Fixed |
| FRIEND-001 | User Friend Service | `GetFriendApplyList` / `GetSentApplyList` 未传 `status` 时直接透传 `0`（待处理），不自动扩展为“全部状态” | 未传 `status` 时可选返回全部状态，或在文档中明确默认只看待处理 | 直连 gRPC 调用时容易与网关行为（缺省改为 `-1`）产生语义偏差 | 中 | Fixed |
| FRIEND-002 | Gateway Friend Handler | `GetFriendApplyList` / `GetSentApplyList` / `GetFriendList` 先 `ShouldBindQuery` 且 `page/pageSize` 有 `min=1`，缺失参数时默认值分支不可达 | 缺省分页参数时自动回填 `page=1`、`pageSize=20` | 调用方不传分页参数会直接报参错，和“默认分页”注释不一致 | 中 | Fixed |
| FRIEND-003 | Gateway Router | 好友申请已读路由 `/api/v1/auth/friend/apply/read` 未注册（被注释） | 路由应可达并进入 `MarkApplyAsRead` 处理链路 | 客户端调用固定返回 404，功能不可用 | 中 | Fixed |
| USER-001 | Gateway User Handler | `SearchUser` 查询参数绑定对键名大小写敏感，常见小写参数（如 `keyword/page/pageSize`）会触发参数错误 | 接受常见小写查询参数并按约定回填默认值 | 网关对外接口可用性受影响，前端/第三方调用易踩坑 | 中 | Open |
| USER-002 | Gateway User Service | `GetOtherProfile` 使用 `async.RunSafe` + channel 等待结果，若协程池未初始化，任务不执行导致等待阻塞 | 协程池未初始化时仍可安全降级返回（不阻塞） | 存在请求卡死风险（启动顺序/测试环境更容易触发） | 高 | Open |

## 风险详情

### AUTH-001
- 证据代码：
  - `apps/gateway/internal/service/auth_service.go:196`
  - `apps/gateway/internal/service/auth_service.go:226`
  - `apps/gateway/internal/dto/auth_dto.go:306`
  - `apps/gateway/internal/dto/auth_dto.go:314`
- 当前结论：
  - 已修复：`ConvertLogoutResponseFromProto(nil)` 与 `ConvertResetPasswordResponseFromProto(nil)` 均返回空对象而非 `nil`。
  - 现行为：Gateway Auth Service 成功路径返回非 `nil` 响应对象，契约与 Handler/调用方预期一致。
- 修复位置：
  - `apps/gateway/internal/dto/auth_dto.go`
  - `apps/gateway/internal/service/auth_service_test.go`

### BLACKLIST-001
- 证据代码：
  - `apps/gateway/internal/router/v1/blacklist_handle.go:115`
  - `apps/gateway/internal/router/v1/blacklist_handle.go:120`
  - `apps/gateway/internal/router/v1/blacklist_handle.go:123`
  - `apps/gateway/internal/dto/blacklist_dto.go:27`
  - `apps/gateway/internal/dto/blacklist_dto.go:28`
- 当前结论：
  - 已修复：分页字段校验调整为 `omitempty,min=1`，缺参时可进入默认值回填逻辑。
  - 现行为：`GetBlacklistList` 缺省 `page/pageSize` 时回填 `1/20` 并正常调用 service。
- 修复位置：
  - `apps/gateway/internal/dto/blacklist_dto.go`
  - `apps/gateway/internal/router/v1/blacklist_handle_test.go`
  - `apps/gateway/internal/router/router_blacklist_test.go`

### FRIEND-001
- 证据代码：
  - `apps/user/internal/service/friend_service.go:201`
  - `apps/user/internal/service/friend_service.go:308`
  - `apps/gateway/internal/router/v1/friend_handle.go:89`
  - `apps/gateway/internal/router/v1/friend_handle.go:149`
- 当前结论：
  - 已修复：Gateway 不再隐式把缺省 `status` 改为 `-1`，缺省语义与 user service 一致为 `0`（待处理）。
  - 同步增强：Gateway DTO 允许显式传 `-1` 代表“全部状态”。
- 修复位置：
  - `apps/gateway/internal/router/v1/friend_handle.go`
  - `apps/gateway/internal/dto/friend_dto.go`
  - `apps/gateway/internal/router/v1/friend_handle_test.go`

### FRIEND-002
- 证据代码：
  - `apps/gateway/internal/router/v1/friend_handle.go:76`
  - `apps/gateway/internal/router/v1/friend_handle.go:92`
  - `apps/gateway/internal/router/v1/friend_handle.go:136`
  - `apps/gateway/internal/router/v1/friend_handle.go:152`
  - `apps/gateway/internal/router/v1/friend_handle.go:291`
  - `apps/gateway/internal/router/v1/friend_handle.go:299`
  - `apps/gateway/internal/dto/friend_dto.go:44`
  - `apps/gateway/internal/dto/friend_dto.go:45`
  - `apps/gateway/internal/dto/friend_dto.go:77`
  - `apps/gateway/internal/dto/friend_dto.go:78`
  - `apps/gateway/internal/dto/friend_dto.go:129`
  - `apps/gateway/internal/dto/friend_dto.go:130`
- 当前结论：
  - 已修复：Friend 列表相关分页字段改为 `omitempty,min=1`，缺省参数可进入 handler 默认分页逻辑。
  - 现行为：`GetFriendApplyList` / `GetSentApplyList` / `GetFriendList` 缺省分页时回填 `1/20`。
- 修复位置：
  - `apps/gateway/internal/dto/friend_dto.go`
  - `apps/gateway/internal/router/v1/friend_handle_test.go`
  - `apps/gateway/internal/router/router_friend_test.go`

### FRIEND-003
- 证据代码：
  - `apps/gateway/internal/router/router.go`
- 当前结论：
  - 已修复：`/api/v1/auth/friend/apply/read` 路由已恢复注册。
  - 现行为：携带鉴权后可正常进入 `MarkApplyAsRead` handler。
- 修复位置：
  - `apps/gateway/internal/router/router.go`
  - `apps/gateway/internal/router/router_friend_test.go`

### USER-001
- 证据代码：
  - `apps/gateway/internal/router/v1/user_handle.go:111`
  - `apps/gateway/internal/router/v1/user_handle.go:119`
  - `apps/gateway/internal/dto/friend_dto.go:11`
  - `apps/gateway/internal/dto/friend_dto.go:12`
  - `apps/gateway/internal/dto/friend_dto.go:13`
- 当前结论：
  - 单测中使用 `keyword/page/pageSize` 无法通过绑定校验，需使用 `Keyword/Page/PageSize` 才能命中成功分支。
  - 这意味着常见调用方式可能被判为 `CodeParamError`。
- 处置建议：
  - 为 `SearchUserRequest` 增加 `form` 标签并固定小写参数；或统一在网关层文档中声明必须使用的键名。

### USER-002
- 证据代码：
  - `apps/gateway/internal/service/user_service.go:95`
  - `apps/gateway/internal/service/user_service.go:101`
  - `apps/gateway/internal/service/user_service.go:107`
  - `pkg/async/pool.go:90`
  - `pkg/async/pool.go:142`
- 当前结论：
  - `GetOtherProfile` 依赖异步任务向 channel 回写结果；若 `async` 全局池未初始化，`RunSafe` 提交失败后不会执行任务，读取 channel 可能阻塞。
  - 在单测中需要显式初始化 `async` 才能稳定覆盖该路径。
- 处置建议：
  - 在 `GetOtherProfile` 中对 `RunSafe` 提交失败增加兜底执行（同步调用或快速失败）。
  - 或在服务启动阶段硬性保证 `async` 初始化完成并加入健康检查。

## 跟踪约定
- 新增风险时在表格追加，并补充“风险详情”。
- 风险修复后将状态改为 `Fixed`，并补充修复 PR 或提交信息。
